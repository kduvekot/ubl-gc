name: Build PoC - ABIE-Level History

on:
  workflow_dispatch:
    inputs:
      clean_start:
        description: 'Delete existing PoC branch and start fresh'
        required: false
        type: boolean
        default: true
  push:
    branches:
      - 'claude/review-ubl-build-scripts-wsfi6'
    paths:
      - '.github/workflows/build-poc-granular.yml'
      - 'scripts/lib/gc_*.py'
      - 'scripts/build-poc-granular.sh'

permissions:
  contents: write

jobs:
  build-poc:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      POC_BRANCH: poc-history
      SOURCE_FILE: history/generated/prd-UBL-2.0/mod/UBL-Entities-2.0.gc
      TARGET_FILE: UBL-Entities.gc

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Configure Git
        run: |
          git config user.name "OASIS UBL TC"
          git config user.email "ubl-tc@oasis-open.org"

      - name: Delete existing PoC branch (if clean start)
        if: inputs.clean_start != false
        run: |
          if git ls-remote --heads origin "$POC_BRANCH" | grep -q "$POC_BRANCH"; then
            echo "Deleting existing remote branch $POC_BRANCH..."
            git push origin --delete "$POC_BRANCH" || true
          fi
          git branch -D "$POC_BRANCH" 2>/dev/null || true

      - name: Create orphan branch
        run: |
          git checkout --orphan "$POC_BRANCH"
          git rm -rf --cached . 2>/dev/null || true
          git clean -fd 2>/dev/null || true

      - name: Restore source files
        run: |
          # Restore only what we need from main branch
          git checkout "${{ github.sha }}" -- "$SOURCE_FILE"
          git checkout "${{ github.sha }}" -- scripts/lib/gc_analyzer.py
          git checkout "${{ github.sha }}" -- scripts/lib/gc_builder.py
          git checkout "${{ github.sha }}" -- scripts/lib/gc_commit_builder.py

      - name: Create initial README
        run: |
          cat > README.md << 'READMEEOF'
          # UBL GenericCode Evolution - Proof of Concept (ABIE-Level)

          This branch demonstrates **ABIE-level git history** for UBL semantic model evolution.

          ## What is this?

          A proof-of-concept showing UBL 2.0 PRD built incrementally:
          - **~131 commits** for one release (1 skeleton + 130 ABIE groups)
          - Each commit adds one complete ABIE (with all its BBIEs and ASBIEs)
          - File is valid GenericCode XML at every commit
          - No forward references (topologically sorted using Tarjan's SCC algorithm)
          - One cycle group (4 mutually dependent ABIEs committed together)

          ## Build Strategy

          ABIEs are added in **dependency order** (leaves first, documents last):

          1. **Skeleton** - Empty GenericCode file with header and column definitions
          2. **Leaf ABIEs** - ABIEs with no external dependencies (Address Line, Country, etc.)
          3. **Dependent ABIEs** - ABIEs that reference others (topologically sorted)
          4. **Cycle group** - Mutually dependent ABIEs committed together (Despatch Line + Receipt Line + Shipment + Transport Handling Unit)
          5. **Document ABIEs** - Top-level documents (Invoice, Order, etc.)

          ## Statistics

          | Metric | Count |
          |--------|-------|
          | Total commits | ~131 |
          | Total rows | 1,604 |
          | ABIEs | 133 |
          | BBIEs | 848 |
          | ASBIEs | 623 |
          | Cycle groups | 1 (4 ABIEs) |
          | Self-referencing ABIEs | 5 |

          ## Commit Message Format

          ```
          UBL 2.0 PRD [42/130]: Add "Party"

          ABIE: Party
          Components: 3 BBIEs, 9 ASBIEs
          Total rows: 13
          ```

          ---

          Built with GitHub Actions
          READMEEOF

          git add README.md
          git commit -m "Initialize PoC: ABIE-level UBL history

          This branch demonstrates building UBL GenericCode files
          incrementally with one commit per ABIE group.

          For UBL 2.0 PRD: ~131 commits showing ABIE-by-ABIE evolution.
          Strategy: Tarjan's SCC + topological sort for dependency ordering.

          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          https://claude.ai/code/session_01B5kfoVeuncQaSCz9nX4H1j"

      - name: Build ABIE-level commits
        run: |
          cd "$GITHUB_WORKSPACE"

          python3 << 'PYEOF'
          import sys
          sys.path.insert(0, 'scripts/lib')

          from gc_analyzer import GCAnalyzer
          from gc_builder import GCBuilder
          from gc_commit_builder import GCCommitBuilder
          import os

          SOURCE_FILE = os.environ['SOURCE_FILE']
          TARGET_FILE = os.environ['TARGET_FILE']

          print("=" * 70)
          print("ANALYZING SOURCE FILE")
          print("=" * 70)

          analyzer = GCAnalyzer(SOURCE_FILE)
          analyzer.parse()
          analyzer.build_abies()
          analyzer.build_dependency_graph()
          analyzer.find_sccs_tarjan()
          analyzer.topological_sort_sccs()

          print("\n" + "=" * 70)
          print("PLANNING BUILD")
          print("=" * 70)

          builder = GCBuilder(analyzer)
          steps = builder.plan_build()
          print(builder.generate_build_plan_summary())

          print("\n" + "=" * 70)
          print("CREATING COMMITS")
          print("=" * 70)

          commit_builder = GCCommitBuilder(SOURCE_FILE, TARGET_FILE, '.')
          commit_builder.analyzer_abies = analyzer.abies

          print("\nCreating initial empty GenericCode file...")
          commit_builder.create_empty_gc_file()
          commit_builder._git_add_and_commit(
              "UBL 2.0 PRD: Initialize GenericCode file structure\n\n"
              "Empty file with header, column definitions, and empty SimpleCodeList.\n"
              "Source: UBL 2.0 Proposed Recommendation Draft (2006)"
          )

          commit_builder.build_incremental(steps)

          print("\n" + "=" * 70)
          print(f"BUILD COMPLETE: {len(steps) + 1} commits created")
          print("=" * 70)
          PYEOF

      - name: Push PoC branch
        run: |
          MAX_RETRIES=4
          DELAY=2

          for i in $(seq 1 $MAX_RETRIES); do
            if git push -u origin "$POC_BRANCH" --force; then
              echo "Push successful!"
              exit 0
            fi
            if [ $i -lt $MAX_RETRIES ]; then
              echo "Push failed, retrying in ${DELAY}s..."
              sleep $DELAY
              DELAY=$((DELAY * 2))
            else
              echo "Push failed after $MAX_RETRIES attempts"
              exit 1
            fi
          done

      - name: Summary
        if: always()
        run: |
          COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "unknown")
          echo "## PoC Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`$POC_BRANCH\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commits | $COMMIT_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| File | \`$TARGET_FILE\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Strategy | ABIE-level (Tarjan SCC + topological sort) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "git fetch origin $POC_BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "git log --oneline origin/$POC_BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
