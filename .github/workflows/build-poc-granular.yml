name: Build PoC - Ultra-Granular History

on:
  workflow_dispatch:
    inputs:
      clean_start:
        description: 'Delete existing PoC branch and start fresh'
        required: false
        type: boolean
        default: true
  push:
    branches:
      - 'claude/git-history-exploration-bunUn'
    paths:
      - '.github/workflows/build-poc-granular.yml'
      - 'scripts/lib/gc_*.py'

permissions:
  contents: write  # Need write access to push to PoC branch

jobs:
  build-poc:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Configure Git
        run: |
          git config --global user.name "OASIS UBL TC"
          git config --global user.email "ubl-tc@oasis-open.org"
          git config --global commit.gpgsign false

      - name: Set up environment
        run: |
          echo "REPO_ROOT=$(pwd)" >> $GITHUB_ENV
          echo "POC_BRANCH=claude/poc-granular-history-bunUn" >> $GITHUB_ENV
          echo "SOURCE_FILE=history/generated/prd-UBL-2.0/mod/UBL-Entities-2.0.gc" >> $GITHUB_ENV
          echo "TARGET_FILE=UBL-Entities.gc" >> $GITHUB_ENV

      - name: Delete existing PoC branch if requested
        if: ${{ inputs.clean_start }}
        run: |
          cd "$REPO_ROOT"
          if git ls-remote --heads origin $POC_BRANCH | grep -q $POC_BRANCH; then
            echo "Deleting existing remote branch..."
            git push origin --delete $POC_BRANCH || true
          fi

      - name: Set up working directory for PoC
        run: |
          # Use /tmp for isolation (same pattern as history branch workflow)
          export POC_WORK_DIR="/tmp/ubl-poc-$$"
          echo "POC_WORK_DIR=$POC_WORK_DIR" >> $GITHUB_ENV

          echo "Creating new PoC branch in temp directory..."
          mkdir -p "$POC_WORK_DIR"
          cd "$POC_WORK_DIR"

          # Initialize fresh repo with orphan branch
          git init
          git checkout --orphan "$POC_BRANCH"

          # Configure git
          git config user.name "OASIS UBL TC"
          git config user.email "ubl-tc@oasis-open.org"
          git config commit.gpgsign false

          # Set up authenticated remote
          REMOTE_URL=$(cd $REPO_ROOT && git remote get-url origin)
          git remote add origin "$REMOTE_URL"

          # CRITICAL: Copy GitHub Actions authentication config
          # The token is passed via http.extraheader, not in the URL
          AUTH_HEADER=$(cd $REPO_ROOT && git config --get http.https://github.com/.extraheader || echo "")
          if [ -n "$AUTH_HEADER" ]; then
            git config http.https://github.com/.extraheader "$AUTH_HEADER"
            echo "‚úì GitHub authentication configured"
          else
            echo "‚ö† Warning: No GitHub auth header found"
          fi

          echo "‚úì Initialized PoC branch in $POC_WORK_DIR"

      - name: Create initial README
        run: |
          cd "$POC_WORK_DIR"

          cat > README-POC.md << 'EOF'
          # UBL GenericCode Evolution - Proof of Concept

          This branch demonstrates **ultra-granular git history** for UBL semantic model evolution.

          ## What is this?

          A proof-of-concept showing UBL 2.0 PRD built incrementally:
          - **232 commits** for one release
          - Each commit adds one element (ABIE, BBIE, or ASBIE)
          - File is valid XML at every commit
          - No forward references

          ## Build Strategy

          **Phase 1: Leaf ABIEs (34 commits)**
          - Add ABIEs with no dependencies
          - Complete with all BBIEs and ASBIEs

          **Phase 2: Non-leaf ABIEs + BBIEs (99 commits)**
          - Add ABIEs with dependencies
          - Include BBIEs only (defer ASBIEs)

          **Phase 3: ASBIEs (99 commits)**
          - Add deferred ASBIEs
          - All references now valid

          ## Viewing the History

          ```bash
          # Clone the repository and checkout this branch
          git clone https://github.com/${{ github.repository }}.git
          cd ubl-gc
          git checkout claude/poc-granular-history-bunUn

          # See all commits
          git log --oneline --graph

          # See first 20 commits
          git log --oneline -20

          # See a specific commit
          git show <commit-hash>

          # See the file at a specific point
          git show <commit-hash>:UBL-Entities.gc

          # See what changed in each commit
          git log --patch UBL-Entities.gc
          ```

          ## Example Commits

          The history shows the incremental build process:

          ```
          üå± Step 1/232: Add leaf ABIE: Address Line. Details
          üå± Step 2/232: Add leaf ABIE: Classification Category. Details
          ...
          üèóÔ∏è Step 35/232: Add ABIE+BBIEs: Application Response. Details
          ...
          üîó Step 134/232: Add ASBIEs: Application Response. Details
          ```

          ## Statistics

          - **Total commits**: 233 (1 initial + 232 build steps)
          - **Total rows added**: 1,604
          - **ABIEs**: 133
          - **Leaf ABIEs**: 34
          - **Non-leaf ABIEs**: 99

          ## Evolution Potential

          If applied to all 35 UBL releases with transitions:
          - **~8,120 commits** showing complete evolution
          - From UBL 2.0 (2006) to UBL 2.5 (2025)
          - Every element addition visible as a commit

          ---

          Built with GitHub Actions
          Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF

          git add README-POC.md
          git commit -m "üìã Initialize PoC: Ultra-granular UBL history

          This branch demonstrates building UBL GenericCode files
          incrementally with one commit per element addition.

          For UBL 2.0 prd: 232+ commits showing element-by-element evolution.

          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "‚úì Created initial commit"

      - name: Copy Python scripts and source file
        run: |
          cd "$POC_WORK_DIR"

          # Copy Python analyzer/builder from main repo
          mkdir -p scripts/lib
          cp "$REPO_ROOT"/scripts/lib/gc_analyzer.py scripts/lib/
          cp "$REPO_ROOT"/scripts/lib/gc_builder.py scripts/lib/
          cp "$REPO_ROOT"/scripts/lib/gc_commit_builder.py scripts/lib/

          # Copy source file
          mkdir -p $(dirname "$SOURCE_FILE")
          cp "$REPO_ROOT/$SOURCE_FILE" "$SOURCE_FILE"

          echo "‚úì Copied scripts and source file"

      - name: Run PoC builder
        run: |
          cd "$POC_WORK_DIR"

          python3 << 'PYTHON_SCRIPT'
          import sys
          import os

          # Add lib to path
          sys.path.insert(0, 'scripts/lib')

          from gc_analyzer import GCAnalyzer
          from gc_builder import GCBuilder
          from gc_commit_builder import GCCommitBuilder

          SOURCE_FILE = os.environ['SOURCE_FILE']
          TARGET_FILE = os.environ['TARGET_FILE']

          print("="*70)
          print("ANALYZING SOURCE FILE")
          print("="*70)

          analyzer = GCAnalyzer(SOURCE_FILE)
          analyzer.parse()
          analyzer.build_abies()
          analyzer.build_dependency_graph()

          print("\n" + "="*70)
          print("PLANNING BUILD")
          print("="*70)

          builder = GCBuilder(analyzer)
          steps = builder.plan_build()
          print(builder.generate_build_plan_summary())

          print("\n" + "="*70)
          print("CREATING COMMITS")
          print("="*70)

          commit_builder = GCCommitBuilder(SOURCE_FILE, TARGET_FILE, '.')

          # Create initial empty file
          print("\nCreating initial empty GenericCode file...")
          commit_builder.create_empty_gc_file()
          commit_builder._git_add_and_commit("üìã Initialize empty GenericCode file structure")

          # Build incrementally
          commit_builder.build_incremental(steps)

          print("\n" + "="*70)
          print("‚úì BUILD COMPLETE - 232+ commits created!")
          print("="*70)
          PYTHON_SCRIPT

      - name: Push PoC branch with retry
        run: |
          cd "$POC_WORK_DIR"

          MAX_RETRIES=4
          RETRY_DELAY=2

          for i in $(seq 1 $MAX_RETRIES); do
            if git push -u origin $POC_BRANCH; then
              echo "‚úì Push successful!"
              exit 0
            else
              if [ $i -lt $MAX_RETRIES ]; then
                echo "Push failed, retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
                RETRY_DELAY=$((RETRY_DELAY * 2))
              else
                echo "‚ùå Push failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done

      - name: Summary
        if: always()
        run: |
          cd "$POC_WORK_DIR"
          COMMIT_COUNT=$(git rev-list --count $POC_BRANCH)

          echo "="*70
          echo "PoC Build Summary"
          echo "="*70
          echo ""
          echo "Branch: $POC_BRANCH"
          echo "Commits: $COMMIT_COUNT"
          echo "File: $TARGET_FILE"
          echo ""
          echo "View the history:"
          echo "  git clone ${{ github.server_url }}/${{ github.repository }}.git"
          echo "  cd ubl-gc"
          echo "  git checkout $POC_BRANCH"
          echo "  git log --oneline --graph"
          echo ""
