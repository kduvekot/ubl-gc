name: Build UBL History Branch

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target history branch name'
        required: true
        default: 'history'
        type: string
  push:
    branches:
      - 'claude/**'
    paths:
      - 'scripts/**'
      - '.github/workflows/build-history.yml'
      - '.trigger-build'

permissions:
  contents: write

concurrency:
  group: build-history
  cancel-in-progress: false

jobs:
  build-history:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Configure Git
        run: |
          git config --global user.name "OASIS UBL TC"
          git config --global user.email "ubl-tc@oasis-open.org"
          git config --global commit.gpgsign false

      - name: Verify all GenericCode files present
        run: |
          echo "Checking for GenericCode files..."
          total_files=$(find history -name "*.gc" | wc -l)
          echo "Found $total_files GenericCode files"
          if [ "$total_files" -lt 60 ]; then
            echo "ERROR: Expected at least 60 files, found $total_files"
            exit 1
          fi
          echo "Verification passed ($total_files files found)"

      - name: Build history (all 35 releases)
        run: |
          # Use input branch for workflow_dispatch, or "history-test" for push triggers
          TARGET="${{ inputs.target_branch || 'history-test' }}"
          echo "Building history on branch: $TARGET"

          python3 scripts/build_history.py \
            --branch "$TARGET" \
            --push \
            --keep-work-dir
        env:
          PYTHONUNBUFFERED: "1"

      - name: Summary
        if: always()
        run: |
          TARGET="${{ inputs.target_branch || 'history-test' }}"
          echo "## Build History Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Target branch | \`$TARGET\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow run | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View the history:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "git fetch origin $TARGET" >> $GITHUB_STEP_SUMMARY
          echo "git log --oneline origin/$TARGET" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
